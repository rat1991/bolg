<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    Flytiger-Biz前端开发指南 | Rat
</title>
<link rel="shortcut icon" href="https://rat1991.github.io/favicon.ico?v=1595936272524">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://rat1991.github.io/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://rat1991.github.io/media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


        
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://rat1991.github.io">
                <img class="avatar" src="https://rat1991.github.io/images/avatar.png?v=1595936272524" alt="">
            </a>
            <div class="site-title">
                <h1>
                    Rat
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    关于
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            Flytiger-Biz前端开发指南
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2020-06-15</time>
                            
                        </div>
                        
                                <div class="post-content">
                                    <h2 id="侧边菜单动态生成">侧边菜单动态生成</h2>
<p>前端生成侧边菜单需要通过 <a href="http://192.172.9.142:3000/project/22/interface/api/260"><code>接口 /permit/permitMenu/listUserMenuTree</code></a>获取菜单数据和权限列表进行生成。<br>
而调用<code>listUserMenuTree接口</code>前需要调用<a href="">/selectDefaultTenant</a>来获取默认租户，流程如下：</p>
<pre><code class="language-mermaid">   登录成功 --&gt; 调用获取默认租户 ---&gt; 调用获取菜单数据
</code></pre>
<p>获取到菜单数据后需要对数据进行处理生成前端路由（routes）数据，再根据路由routes数据去生成菜单组件。具体生成思路如下：</p>
<pre><code class="language-javascript">/**
 * 过滤菜单数据
 * @param {Array} list -后台返回的菜单数据
 * @param {Object} parent -缓存父级对象
 * @returns {Array}
 */
function sortUserMenus(list, parent) {
  const menus = []
  const access = []
  list.forEach(item =&gt; {
    if (item.category === 1) {
      if (item.children) {
        item.children = sortUserMenus(item.children, item)
      }
      menus.push(item)
    } else {
      access.push({ code: item.code, name: item.name })
    }
  })
  if (parent &amp;&amp; access.length) {
      // 把过滤出的权限列表保存在父节点
    parent['_access'] = access
  }
  return menus.length ? menus : null
}
</code></pre>
<p>以上函数主要是抽离菜单页面路由的权限列表，因为后端返回的数据是以菜单和页面按钮权限一起的树形结构，需要将页面按钮权限抽离处理。</p>
<pre><code class="language-javascript">// 缓存生成的页面路由
let cacheRouters = []
/**
 * 合并路由路径
 * @param  {...any} arg -路径字符
 */
function resolvePath(...arg) {
  return arg.map(url =&gt; {
    return url.split('/').filter(v =&gt; v!=='').join('/')
  }).join('/')
}
/**
 * routes生成器
 * @param {*} menus -后端响应数据
 * @param {*} parentPath -父节点路径
 */
function routesGenerator(menus, parentPath='/') {
  return menus.map(item =&gt; {
    const isChild = item.children &amp;&amp; item.children.length
    const isTop = item.parentId === '0'
    const tpl = {
      path: resolvePath(parentPath, item.code),
      name: item.name,
      meta: {
        icon: item.icon || 'md-document',
        hideInMenu: false,
        notCache: true
      },
    }
    if (!isTop) {
      tpl.path = '/' + tpl.path
      tpl.name = item.code
      tpl.meta.title = item.name
      // requireAuth为true表明该路由需要权限才能进入
      tpl.meta.requireAuth = true
      // 将按钮权限列表放置在前端路由的meta.authList属性上
      if (item._access) {
        tpl.meta.authList = item._access.map(item =&gt; item.code)
      }
    }
    // 判断路径是否为路由组件还是url
    if (item.isOpen) {
      tpl.meta.href = item.path
    } else {
      tpl.component = () =&gt; isTop 
      ? import('@/components/main') 
      : import(`@/view/module/${resolvePath(item.path)}.vue`)
    }
    // 带有子节点递归处理
    if (isChild) {
      tpl.children = routesGenerator(item.children, tpl.path)
      tpl.redirect = tpl.children[0].path
    }
    return tpl
  })
}
/**
 * 主要为生成的routes后加入404页面路由
 * @param {*} menus -后端响应数据
 */
function createMenuRoutes(menus) {
  const unableCatchRoute = {
    path: '/404',
    name: 'error_404',
    meta: {
      hideInMenu: true
    },
    component: () =&gt; import('@/view/error-page/404.vue')
  }
  return [...routesGenerator(menus), unableCatchRoute]
}

function initRoutes(menus) {
  if (cacheRouters.length) return
  cacheRouters = createMenuRoutes(menus)
  router.onReady(() =&gt; {
    // 将生成的routes数据添加在前端路由表
    router.addRoutes(cacheRouters)
    routes.push(...cacheRouters)
    store.commit('setRoutesReady')
  })
}
</code></pre>
<p>通过调用initRoutes()方法将生成的routes数据动态加载的路由中。<br>
最后生成的数据如下：<br>
<img src="https://rat1991.github.io/post-images/1592228665717.png" alt="" loading="lazy"><br>
其中authList为当前路由的按钮权限列表，这样我们可以通过页面组件内的this.$route去获取到它，从而可以根据列出的权限去控制页面按钮的展示。<br>
权限列表中带有<strong>VIEW、ADD、EDIT、DELETE、ENABLE</strong>等分别查看、添加、编辑、删除、禁用的标识，根据标识去控制相应权限的按钮显示。</p>
<p>一般情况下可通过定义全局方法去统一判断：</p>
<pre><code class="language-javascript">/**
 * 按钮全新控制
 *authorities 多个用,号隔开
 * v-show=&quot;$hasAuthority('systemUserCreate')&quot;
 * @param authorities
 * @returns {boolean}
 */
Object.defineProperty(Vue.prototype, '$hasAuthority', {
  value(authorities, isCustom) {
    if (!authorities) return false
    const { authList= [] } = this.$route.meta;
    if(!isCustom)  authorities = 'flytigerbutton' + authorities;
    return authList.toString().toLocaleLowerCase().indexOf(authorities.toLocaleLowerCase()) &gt; -1 ;
  },
  writable: false
})
</code></pre>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">下一篇</div>
                            <a href="https://rat1991.github.io/post/she-jiao-fen-xiang-pei-zhi/">
                                <h3 class="post-title">
                                    社交分享配置
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">目录</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%BE%A7%E8%BE%B9%E8%8F%9C%E5%8D%95%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90">侧边菜单动态生成</a></li>
</ul>
</li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*获取文章目录集合,可通过:header过滤器*/
                var alis = $('.post-content :header');
                /*获取侧边栏目录列表集合**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*获取滚动条到顶部的距离*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*获取锚点集合中的元素分别到顶点的距离*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*高亮显示*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*绑定滚动事件 */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://rat1991.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
</body>

</html>